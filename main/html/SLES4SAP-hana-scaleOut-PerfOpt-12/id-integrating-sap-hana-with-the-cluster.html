<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Integrating SAP HANA with the cluster</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.2" /><style type="text/css">
body { background-image: url('static/images/draft.png');
       background-repeat: no-repeat;
       background-position: top left;
       /* The following properties make the watermark "fixed" on the page. */
       /* I think that's just a bit too distracting for the reader... */
       /* background-attachment: fixed; */
       /* background-position: center center; */
     }</style><link rel="home" href="index.html" title="SAP HANA System Replication Scale-Out - Performance Optimized Scenario" /><link rel="up" href="index.html" title="SAP HANA System Replication Scale-Out - Performance Optimized Scenario" /><link rel="prev" href="id-setting-up-the-sap-hana-system-replication.html" title="Setting up the SAP HANA system replication" /><link rel="next" href="id-configuring-the-cluster-and-sap-hana-resources.html" title="Configuring the cluster and SAP HANA resources" /></head><body onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Integrating SAP HANA with the cluster</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="id-setting-up-the-sap-hana-system-replication.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="id-configuring-the-cluster-and-sap-hana-resources.html">Next</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id-integrating-sap-hana-with-the-cluster"></a>Integrating SAP HANA with the cluster</h2></div></div></div><div class="figure"><a id="id2201"></a><p class="title"><strong>Figure 11. <a class="xref" href="id-planning-the-installation.html#Planning">[Planning]</a> <a class="xref" href="id-setting-up-the-operating-system.html#OsSetup">[OsSetup]</a> <a class="xref" href="id-installing-the-sap-hana-databases-on-both-sites.html#SAPHanaInst">[SAPHanaInst]</a> <a class="xref" href="id-setting-up-the-sap-hana-system-replication.html#SAPHanaHsr">[SAPHanaHsr]</a> Integration <a class="xref" href="id-configuring-the-cluster-and-sap-hana-resources.html#Cluster">[Cluster]</a> <a class="xref" href="id-testing-the-cluster.html#Testing">[Testing]</a></strong></p><div class="figure-contents"><div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td><img src="images/SAPHanaSR-ScaleOut-Plan-Phase5.svg" width="100%" alt="SAPHanaSR ScaleOut Plan Phase5" /></td></tr></table></div></div></div><br class="figure-break" /><p><a id="Integration"></a>Proceed with the following steps:</p><p><span class="strong"><strong>Procedure</strong></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Implement the python hook SAPHanaSR</p></li><li class="listitem"><p>Configure system replication operation mode</p></li><li class="listitem"><p>Allow &lt;sid&gt;adm to access the cluster</p></li><li class="listitem"><p>Start SAP HANA</p></li><li class="listitem"><p>Test the hook integration</p></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-implementing-the-python-hook-saphanasr"></a>Implementing the Python hook SAPHanaSR</h3></div></div></div><p>This step must be done on both sites. SAP HANA must be stopped to change the
<span class="emphasis"><em>global.ini</em></span> and allow SAP HANA to integrate the HA/DR hook script during start.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Install the HA/DR hook script into a read/writable directory</p></li><li class="listitem"><p>Integrate the hook into <span class="emphasis"><em>global.ini</em></span> (SAP HANA needs to be stopped for doing that offline)</p></li><li class="listitem"><p>Check integration of the hook during start-up</p></li></ul></div><p>Take the hook from the SAPHanaSR-scaleOut package and copy it to your preferred
directory like /hana/share/myHooks. The hook must be available on all SAP HANA nodes.</p><pre class="screen">suse01~ # mkdir -p /hana/shared/myHooks
suse01~ # cp /usr/share/SAPHanaSR-ScaleOut/SAPHanaSR.py /hana/shared/myHooks
suse01~ # chown -R &lt;sid&gt;adm:sapsys /hana/shared/myHooks</pre><p>Stop SAP HANA.</p><pre class="screen">sapcontrol -nr &lt;Inst&gt; -function StopSystem</pre><div class="example"><a id="id2245"></a><p class="title"><strong>Example 24. Adding SAPHanaSR via global.ini</strong></p><div class="example-contents"><pre class="screen">[ha_dr_provider_SAPHanaSR]
provider = SAPHanaSR
path = /hana/shared/myHooks
execution_order = 1

[trace]
ha_dr_saphanasr = info</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-configuring-the-system-replication-operation-mode"></a>Configuring the system replication operation mode</h3></div></div></div><p>When your system is connected as an SAPHanaSR target, you can find an entry in the <span class="emphasis"><em>global.ini</em></span> file
which defines the operation mode. Up to now there are two modes available:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="emphasis"><em>delta_datashipping</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>logreplay</em></span></p></li></ul></div><p>Until performing a takeover and re-registration in the opposite direction, the entry for the operation mode is missing on
your primary site. The "classic" operation mode is <span class="emphasis"><em>delta_datashipping</em></span>. The preferred mode for HA is
<span class="emphasis"><em>logreplay</em></span>. Using the operation mode <span class="emphasis"><em>logreplay</em></span> makes your secondary site in the SAP HANA
system replication a hot standby system.
For more details regarding both modes check the SAP documentation such as
"How To Perform System Replication for SAP HANA" (see <a class="link" href="https://www.sap.com/documents/2013/10/26c02b58-5a7c-0010-82c7-eda71af511fa.html" target="_top">https://www.sap.com/documents/2013/10/26c02b58-5a7c-0010-82c7-eda71af511fa.html</a>).</p><p>Check both <span class="emphasis"><em>global.ini</em></span> files and add the operation mode, if needed.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">section</span></dt><dd><p>[ system_replication ]</p></dd><dt><span class="term">key</span></dt><dd><p>operation_mode = logreplay</p></dd></dl></div><p>Path for the <span class="emphasis"><em>global.ini</em></span>: /hana/shared/&lt;SID&gt;/global/hdb/custom/config/</p><pre class="screen">[system_replication]
operation_mode = logreplay</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-allowing-sidadm-to-access-the-cluster"></a>Allowing &lt;sid&gt;adm to access the cluster</h3></div></div></div><p>The current version of the SAPHanaSR python hook uses the command <span class="emphasis"><em>sudo</em></span> to allow
the &lt;sid&gt;adm user to access the cluster attributes. In Linux you can use <span class="emphasis"><em>visudo</em></span>
to start the vi editor for the <span class="strong"><strong>/etc/sudoers</strong></span> configuration file.</p><p>The user &lt;sid&gt;adm must be able to set the cluster attribute hana_&lt;sid&gt;_glob_srHook.
The SAP HANA system replication hook needs password free access. The following
example limits the sudo access to exactly setting the needed attribute.</p><p>Replace the &lt;sid&gt; by the lowercase SAP system ID.</p><div class="example"><a id="id2286"></a><p class="title"><strong>Example 25. Entry in sudo permissions /etc/sudoers file</strong></p><div class="example-contents"><p>Basic parameter option to allow &lt;sidadm&gt; to use the srHook.</p><pre class="screen"># SAPHanaSR-ScaleOut needs for srHook
&lt;sid&gt;adm ALL=(ALL) NOPASSWD: /usr/sbin/crm_attribute -n hana_&lt;sid&gt;_glob_srHook -v *</pre><p>More specific parameters option to meet a high security level.</p><pre class="screen"># SAPHanaSR-ScaleOut needs for srHook
Cmnd_Alias SOK   = /usr/sbin/crm_attribute -n hana_&lt;sid&gt;_glob_srHook -v SOK   -t crm_config -s SAPHanaSR
Cmnd_Alias SFAIL = /usr/sbin/crm_attribute -n hana_&lt;sid&gt;_glob_srHook -v SFAIL -t crm_config -s SAPHanaSR
&lt;sid&gt;adm ALL=(ALL) NOPASSWD: SOK, SFAIL</pre></div></div><br class="example-break" /><div class="example"><a id="id2292"></a><p class="title"><strong>Example 26. Result of replace &lt;sid&gt; with ha1</strong></p><div class="example-contents"><pre class="screen"># SAPHanaSR-ScaleOut needs for srHook
ha1adm ALL=(ALL) NOPASSWD: /usr/sbin/crm_attribute -n hana_ha1_glob_srHook -v *</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-starting-sap-hana"></a>Starting SAP HANA</h3></div></div></div><p>After having completed the SAP HANA integration and having configured the communication between
SAP HANA and the cluster, you can start the SAP HANA databases on both sites.</p><div class="example"><a id="id2298"></a><p class="title"><strong>Example 27. Starting a complete SAP HANA site as use &lt;sid&gt;adm</strong></p><div class="example-contents"><pre class="screen">sapcontrol -nr &lt;Inst&gt; -function StartSystem</pre><p>The <span class="emphasis"><em>sapcontrol</em></span> service commits the request with OK.</p><pre class="screen">11.06.2018 18:30:16
StartSystem
OK</pre><p>Check if SAP HANA has finished starting.</p><pre class="screen">sapcontrol -nr &lt;Inst&gt; -function WaitforStarted 300 20</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-testing-the-hook-integration"></a>Testing the hook integration</h3></div></div></div><p>When the SAP HANA database has been restarted after the changes, check if the hook script is called correctly.</p><p>First check if SAP HANA did create a compiled version of the python script.
The file list in <code class="literal">/hana/shared/myHooks</code> should now also contain a file with
the extension <span class="strong"><strong>pyc</strong></span>.</p><pre class="screen">cd /hana/shared/myHooks; ll</pre><pre class="screen">-rw-r--r-- 1 &lt;sid&gt;adm sapsys 4890 May  4 14:40 SAPHanaSR.py
-rw-r--r-- 1 &lt;sid&gt;adm sapsys 4932 Jun 11 15:00 SAPHanaSR.pyc</pre><p>A second verification is to check the SAP HANA trace files as &lt;sid&gt;adm:</p><pre class="screen">suse01:ha1adm&gt; cdtrace
suse01:ha1adm&gt; awk '/ha_dr_SAPHanaS.*crm_attribute/ \
     { printf "%s %s %s %s\n",$2,$3,$5,$16 }' nameserver_suse01.*
2018-05-04 12:34:04.476445 ha_dr_SAPHanaS...SFAIL
2018-05-04 12:53:06.316973 ha_dr_SAPHanaS...SOK</pre></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="id-setting-up-the-sap-hana-system-replication.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="id-configuring-the-cluster-and-sap-hana-resources.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Setting up the SAP HANA system replication </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Configuring the cluster and SAP HANA resources</td></tr></table></div></body></html>