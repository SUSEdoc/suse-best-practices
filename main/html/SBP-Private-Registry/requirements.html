<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Requirements</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.2" /><style type="text/css">
body { background-image: url('static/images/draft.png');
       background-repeat: no-repeat;
       background-position: top left;
       /* The following properties make the watermark "fixed" on the page. */
       /* I think that's just a bit too distracting for the reader... */
       /* background-attachment: fixed; */
       /* background-position: center center; */
     }</style><link rel="home" href="index.html" title="SUSE Private Registry Powered by Harbor 2.1" /><link rel="up" href="index.html" title="SUSE Private Registry Powered by Harbor 2.1" /><link rel="prev" href="index.html" title="SUSE Private Registry Powered by Harbor 2.1" /><link rel="next" href="high-availability.html" title="High Availability" /></head><body onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Requirements</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="high-availability.html">Next</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="requirements"></a>Requirements</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-kubernetes-distribution"></a>Kubernetes Distribution</h3></div></div></div><p>SUSE Private Registry Powered by Harbor 2.1 can only be deployed on top of a Kubernetes cluster.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Kubernetes 1.17 or higher</p></li><li class="listitem"><p>SUSE CaaS Platform 4.5.x (or higher)</p></li><li class="listitem"><p>K3s</p></li><li class="listitem"><p>RKE2</p><p>or</p></li><li class="listitem"><p>A supported public Kubernetes cloud provider (see <a class="xref" href="id-appendix.html#supported-deployment" title="Table 1. Supported deployment options">Table 1, “Supported deployment options”</a> Options)</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-helm"></a>Helm</h3></div></div></div><p>SUSE Private Registry can only be deployed via the Helm chart.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Helm 3.2 (or higher) required</p><p>Use <a class="link" href="https://software.opensuse.org/package/helm" target="_top">https://software.opensuse.org/package/helm</a> to find a build for your distribution.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-storage"></a>Storage</h3></div></div></div><p>The following types of storage are required for SUSE Private Registry Powered by Harbor 2.1:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Kubernetes persistent volumes</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>SUSE Private Registry internal stateful components require persistent volumes to store their data in a way that survives pod restarts.
A default Kubernetes <code class="literal">StorageClass</code> is needed to dynamically provision the volumes. Alternatively, explicit <code class="literal">StorageClass</code> values may be configured for each component.</p></li></ul></div></li><li class="listitem"><p>Kubernetes persistent shared volumes</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>In addition to regular persistent volumes, a Kubernetes <code class="literal">StorageClass</code> that supports <code class="literal">ReadWriteMany</code> access mode is required to deploy the <code class="literal">registry</code> component - the component providing the OCI registry API and responsible for storing OCI artifacts - in a highly-available and scalable setup. If such a <code class="literal">StorageClass</code> isn’t available in your Kubernetes cluster, an external storage backend may be used instead (see next point). Ultimately, a regular <code class="literal">ReadWriteOnce</code> Kubernetes <code class="literal">StorageClass</code> may still be used for the <code class="literal">registry</code> component, but with HA and scalability features selectively disabled.</p></li></ul></div></li><li class="listitem"><p>External storage for OCI artifacts</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>SUSE Private Registry may optionally be configured to store OCI artifacts (e.g. container images and charts) in an external storage backend such as Azure Blob Storage or Amazon S3, instead of the Kubernetes provided persistent volumes.</p></li></ul></div></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>SUSE CaaS Platform 4.5 provides only very limited options of supported <code class="literal">StorageClass</code> configurations.
Refer to <a class="link" href="https://documentation.suse.com/suse-caasp/4.5/html/caasp-admin/_storage.html" target="_top">SUSE CaaS Platform 4.5 Administration Guide: Storage</a>.</p></div><p>For public cloud deployments it is recommended to use the available hosted solutions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Azure Blob Storage or Amazon S3 for storing OCI artifacts</p></li><li class="listitem"><p>The Azure File Share or Amazon EFS Kubernetes <code class="literal">StorageClass</code> for the <code class="literal">registry</code> component, unless external storage is used to store OCI artifacts</p></li><li class="listitem"><p>The Azure Managed Disk or Amazon EBS Kubernetes <code class="literal">StorageClass</code> for other components that require persistent storage</p></li></ul></div><p>Refer to the table in <a class="xref" href="id-appendix.html#supported-deployment" title="Table 1. Supported deployment options">Table 1, “Supported deployment options”</a> for more details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="requirements-ingress"></a>Ingress</h3></div></div></div><p>The default and recommended way of installing SUSE Private Registry using the helm chart is to employ an ingress service to expose the Harbor service. The Kubernetes cluster where the chart is being deployed needs to have an ingress controller enabled:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>For SUSE CaaS Platform v4.5, check how to deploy <a class="link" href="https://documentation.suse.com/suse-caasp/4.5/single-html/caasp-admin/#nginx-ingress" target="_top">Nginx based Ingress controller with SUSE CaaS Platform</a>.</p></li><li class="listitem"><p>For K3s, traefik ingress controller is deployed by default. It is also possible to disable traefik when installing K3s and install different ingress controller, e.g. Nginx based Ingress controller the same way as for SUSE CaaS Platform.</p></li><li class="listitem"><p>For AKS, the Ingress controller recommended for SUSE Private Registry is the NGINX ingress controller.
Follow the documentation on <a class="link" href="https://docs.microsoft.com/en-us/azure/aks/ingress-basic" target="_top">Creating an Ingress Controller in AKS</a>, or <a class="link" href="https://docs.microsoft.com/en-us/azure/aks/ingress-tls" target="_top">Creating an HTTPS ingress controller on AKS</a>.
The latter also provides extended instructions about providing support for resolvable FQDNs and generating TLS certificates, which are also SUSE Private Registry requirements.</p></li><li class="listitem"><p>For EKS, the Ingress controller recommended for SUSE Private Registry is the ALB ingress controller. Follow the documentation on <a class="link" href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html" target="_top">Creating an ALB Ingress Controller on EKS</a>.</p></li></ul></div><p>Alternatively, the Harbor service may be exposed directly via a dedicated Kubernetes LoadBalancer, without requiring an Ingress controller.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-resolvable-fqdns"></a>Resolvable FQDNs</h4></div></div></div><p>If the Kubernetes Ingress is the chosen option for exposing the SUSE Private Registry services, it is also required to associate FQDN entries with the exposed SUSE Private Registry endpoints: one FQDN for the Harbor UI/API and another one for the image signing (notary) service, if enabled.</p><p>Both these FQDNs need to be resolvable to the external IP address allocated for the Kubernetes Ingress controller and they must not have the same value. Setting this up depends largely on the host infrastructure and the Kubernetes distribution on top of which SUSE Private Registry is installed. Providing complete instructions on allocating FQDNs and configuring external DNS services to resolve them is outside the scope of this document, but some suggestions are provided in this section.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="id-nip-io"></a>nip.io</h5></div></div></div><p>For simple deployments, an external public service such as <a class="link" href="https://nip.io" target="_top">nip.io</a> may be used to provide quick DNS mapping for IP addresses without requiring additional services or infrastructure configuration changes. For example, if the external IP address allocated to the Kubernetes Ingress Controller is 10.86.0.237, then the FQDNs used for the Harbor UI/API and notary endpoints might be:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>harbor.10.86.0.237.nip.io</p></li><li class="listitem"><p>notary.10.86.0.237.nip.io</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="id-azure-aks-use-a-dns-zone"></a>Azure AKS - Use a DNS Zone</h5></div></div></div><p>For AKS, a DNS zone may be configured and used as a custom domain for all FQDNs associated with the Ingress.
Follow the steps documented in <a class="link" href="https://docs.microsoft.com/en-us/azure/aks/ingress-tls" target="_top">Creating an HTTPS ingress controller on AKS</a> on associating an Azure DNS zone with the external IP allocated for an Ingress Controller.</p><p>For example, if the Azure DNS zone mapped to the external IP allocated to the Kubernetes Ingress controller is <code class="literal">MY_CUSTOM_DOMAIN</code>, then the FQDNs used for the Harbor UI/API and notary endpoints might be:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>harbor.MY_CUSTOM_DOMAIN</p></li><li class="listitem"><p>notary.MY_CUSTOM_DOMAIN</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="id-amazon-eks-use-the-alb-ingress-controller"></a>Amazon EKS - Use the ALB Ingress Controller</h5></div></div></div><p>For EKS, the ALB ingress controller already includes a DNS zone that is automatically used to derive FQDNs for every Ingress instance.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="requirements-tls"></a>TLS Certificates</h3></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>Detailed instructions on generating TLS certificates are outside the scope of this document, but some suggestions are provided in the installation section.</p></div><p>By default, SUSE Private Registry is configured to auto-generate TLS certificates associated with the Harbor UI/API and Notary API FQDNs, independently of the way used to expose the services. While this option simplifies the installation process, it also uses self-signed CA certificates that must be explicitly installed on every machine where clients will interact with the registry. For situation when this is not desirable, such as production deployments, custom certificates need to be generated ahead of time and provided during installation.</p><p>The custom certificates must reflect the FQDNs, domain name, or external IP address that will be used by clients to access the SUSE Private Registry services. For example, if a Kubernetes Ingress is used, one TLS certificate will be required for the Harbor UI/API FQDN and another one for the Notary FQDN. The second option is to create a single certificate to be used for both services, with the SAN value configured to match both FQDNs. A third option is to create a single certificate for the entire subdomain used to derive both FQDNs.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-kubernetes-cert-manager"></a>Kubernetes cert-manager</h4></div></div></div><p>The <a class="link" href="https://cert-manager.io/" target="_top">cert-manager</a> open source solution could be leveraged to manage certificates.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-nginx-ingress-controller"></a>NGINX Ingress Controller</h4></div></div></div><p>This type of Kubernetes Ingress Controller supports configuring a default SSL certificate that may be used in common for all services that use it.
Detailed instructions on how to do that are available in <a class="link" href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/" target="_top">the official NGINX Ingress Controller documentation</a>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-eks-aws-certificate-manager"></a>EKS - AWS Certificate Manager</h4></div></div></div><p>AWS includes an <a class="link" href="https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html" target="_top">AWS Certificate Manager</a> service that can be used to manage certificates.
The ALB Ingress Controller also supports configuring a default SSL certificate associated with the underlying Application Load Balancer.
Detailed instructions on how to do that are available in the <a class="link" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html#https-listener-certificates" target="_top">Creating an HTTPS Listener for an ALB</a> documentation.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="requirements-external-postgres"></a>External PostgreSQL Database</h3></div></div></div><p>An internal database is provided with the SUSE Private Registry helm chart, but this builtin service is not highly available nor scalable.
For production deployments running in public cloud, it is recommended that a highly-available and scalable managed PostgreSQL database instance be created and configured as an external database for SUSE Private Registry.
This section covers only high-level instructions on creating a managed PostgreSQL database instance for Azure and AWS.
For detailed instructions, please refer to the official documentation:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Azure: <a class="link" href="https://docs.microsoft.com/en-us/azure/postgresql/" target="_top">Azure Database for PostgreSQL</a></p></li><li class="listitem"><p>AWS: <a class="link" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html" target="_top">PostgreSQL on Amazon RDS</a></p></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-azure-postgresql"></a>Azure PostgreSQL</h4></div></div></div><p>To deploy Azure PosgreSQL server, use <code class="literal">az</code> command line client like this:</p><pre class="screen">az postgres server create --location germanywestcentral --resource-group &lt;azure-resource-group&gt; --name &lt;azure-postgres-server&gt; --admin-user &lt;admin-user&gt; --admin-password &lt;admin-password&gt; --sku-name B_Gen5_2</pre><p>Alternatively, the database server can be created from the Azure Portal page.</p><p>After the server creation, it is necessary to manually create the following empty databases: <code class="literal">registry</code>, <code class="literal">notary_server</code> and <code class="literal">notary_signer</code>.</p><p>This can be achieved using the <code class="literal">az</code> command line client like this:</p><pre class="screen">az postgres db create --resource-group &lt;azure-resource-group&gt; --server-name &lt;azure-postgres-server&gt; -name registry
az postgres db create --resource-group &lt;azure-resource-group&gt; --server-name &lt;azure-postgres-server&gt; -name notary_server
az postgres db create --resource-group &lt;azure-resource-group&gt; --server-name &lt;azure-postgres-server&gt; -name notary_signer</pre><p>Do not forget to set up correct firewall rules so that other services are able to access the database.</p><p>For example, one can setup a rule to enable access from all other Azure services using the command line client:</p><pre class="screen">az postgres server firewall-rule create --resource-group &lt;azure-resource-group&gt; --server-name &lt;azure-postgres-server&gt; -n azure-services-rule --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0</pre><p>When accessing the database from an on-premise Kubernetes cluster, set up the firewall rules accordingly.
You can adapt Firewall rules from Azure Portal as well.</p><p>Find out the URL of the database as well as the username and password that was used when creating the database server.</p><p>For Azure, the host name will likely look like <code class="literal">&lt;postgres-server&gt;.postgres.database.azure.com</code>.
These will be required during the SUSE Private Registry installation. You can also find it in the Azure Portal in the <code class="literal">Connection Strings</code> section.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-aws-rds"></a>AWS RDS</h4></div></div></div><p>SUSE Private Registry is compatible with Amazon RDS using the Amazon Aurora-PostgreSQL or PostgreSQL service.</p><p>The RDS database can be created from the AWS RDS Management Console or by using the <code class="literal">aws</code> cli using
the following command:</p><pre class="screen">aws rds create-db-instance
    --engine postgres \
    --allocated-storage 25 \
    --db-instance-class db.t3.medium \
    --db-security-groups &lt;mydbsecuritygroup&gt; \
    --db-subnet-group &lt;mydbsubnetgroup&gt; \
    --master-username &lt;masterawsuser&gt; \
    --master-user-password &lt;masteruserpassword&gt; \
    --backup-retention-period 3</pre><p>When accessing the database from an on-premise Kubernetes cluster, set up the firewall rules accordingly.
You can adapt Firewall rules from AWS Management Console as well.</p><p>Please record the URL of the database as well as the username and password that was used when creating the database server.</p><p>These will be required during the SUSE Private Registry installation.</p><p>After the server creation, it is necessary to manually create the following empty databases: <code class="literal">registry</code>, <code class="literal">notary_server</code> and <code class="literal">notary_signer</code>.
Use your favorite database client tool (like <code class="literal">psql</code>) to connect to the database server and create these databases.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="requirements-redis-external"></a>External Redis</h3></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>Securing connections to the external Redis with TLS/SSL is currently not supported.</p></div><p>An internal Redis service is provided with the SUSE Private Registry helm chart, but this builtin service is not highly available nor scalable.
For production deployments running in public cloud, it is recommended that a highly-available and scalable managed Redis instance be created and configured as an external Redis for SUSE Private Registry.
This section covers only high-level instructions on creating a managed Redis instance for Azure and AWS.</p><p>For detailed instructions, please refer to the official documentation:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Azure: <a class="link" href="https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/" target="_top">Azure Cache for Redis</a></p></li><li class="listitem"><p>AWS: <a class="link" href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/WhatIs.html" target="_top">Amazon ElastiCache for Redis</a>.</p></li></ul></div><p>As an alternative, the SUSE Redis operator may be used to deploy a Kubernetes managed Redis service and not rely on a public cloud managed Redis service.
This is covered in the SUSE Private Registry installation instructions.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="requirements-redis-azure"></a>Azure Cache for Redis</h4></div></div></div><p>To deploy Redis Cache in Azure, you can use the command line client and run it like this:</p><pre class="screen">az redis create --location &lt;azure-location&gt; --name &lt;azure-redis-cache&gt; --resource-group &lt;azure-resource-group&gt; --sku Basic --vm-size c0 --enable-non-ssl-port</pre><p>Use the right value with your resource group and location. The option for enabling non-ssl port is necessary, as Harbor does not support SSL connection to Redis.
Use the options for <code class="literal">sku</code> and <code class="literal">vm-size</code> options that fit your needs.
Using the name you will provide as <code class="literal">&lt;azure-redis-chache&gt;</code>, Azure will generate DNS name for your Redis Cache in the form of <code class="literal">&lt;azure-redis-cache&gt;.redis.cache.windows.net</code>.
Use this address for the <code class="literal">addr</code> key when adapting the <code class="literal">harbor-values.yaml</code> file later.
Refer to <a class="xref" href="id-deployment-of-suse-private-registry.html#install-external-redis">[install-external-redis]</a> in the Deployment section.</p><p>Once the Redis Cache is created, obtain the access key that you will need for connection. List the access keys using the CLI this way:</p><pre class="screen">az redis list-keys --name &lt;azure-redis-cache&gt; --resource-group &lt;azure-resource-group&gt;</pre><p>Alternatively, the Redis Cache can be created from Azure Portal page. The access keys can be found in the Settings/Access keys section.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-amazon-elasticache-for-redis"></a>Amazon ElastiCache for Redis</h4></div></div></div><p>To deploy Redis Cache in AWS, you can use the aws command line client and run it like this:</p><pre class="screen">aws elasticache create-cache-cluster \
--cache-cluster-id my-cluster \
--cache-node-type cache.t3.small \
--engine redis \
--num-cache-nodes 1</pre><p>For enabling High Availability, the Redis Cache needs to be added to a ElastiCache cluster. Please
read the <a class="link" href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/Clusters.Create.CLI.html" target="_top">AWS CLI documentation</a> for further details.</p><p>Refer to <a class="xref" href="id-deployment-of-suse-private-registry.html#install-external-redis">[install-external-redis]</a> in the Deployment section.</p><p>Alternatively, the Redis Cache can be created from AWS Management Console.</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="high-availability.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">SUSE Private Registry Powered by Harbor 2.1 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> High Availability</td></tr></table></div></body></html>