<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Administration</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.2" /><style type="text/css">
body { background-image: url('static/images/draft.png');
       background-repeat: no-repeat;
       background-position: top left;
       /* The following properties make the watermark "fixed" on the page. */
       /* I think that's just a bit too distracting for the reader... */
       /* background-attachment: fixed; */
       /* background-position: center center; */
     }</style><link rel="home" href="index.html" title="SAP S/4 HANA - Enqueue Replication 2 High Availability Cluster - Setup Guide" /><link rel="up" href="index.html" title="SAP S/4 HANA - Enqueue Replication 2 High Availability Cluster - Setup Guide" /><link rel="prev" href="id-implementing-the-cluster.html" title="Implementing the cluster" /><link rel="next" href="multicluster.html" title="Multi-node cluster setups for an SAP S/4HANA" /></head><body onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Administration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="id-implementing-the-cluster.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="multicluster.html">Next</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id-administration"></a>Administration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-dos-and-donts"></a>Dos and don’ts</h3></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Before each test, verify that the cluster is in idle state, no migration constraints are active,
and no resource failure messages are visible. Start each procedure with a clean setup.
See also manual pages sap_suse_cluster_connector(8), cs_clusterstate(8), crm(8) and crm_mon(8).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-migrating-the-ascs-instance"></a>Migrating the ASCS instance</h4></div></div></div><p>To <span class="strong"><strong>migrate</strong></span> the ASCS SAP instance, you should use SAP tools such as
the SAP management console. This will trigger <span class="strong"><strong>sapstartsrv</strong></span> to use the
sap-suse-cluster-connector to migrate the ASCS instance. As user <span class="emphasis"><em>en2adm</em></span> you can run
the command below to migrate the ASCS. This will always
migrate the ASCS to the ERS side which will keep the SAP enqueue locks.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, type the command:</p><pre class="screen"># sapcontrol -nr 00 -function HAFailoverToNode ""</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-never-block-resources"></a>Never block resources</h4></div></div></div><p>With SAP S/4-HA-CLU 1.0 it is <span class="strong"><strong>no longer allowed to block resources</strong></span> from being
  controlled manually. This means using the variable <span class="emphasis"><em>BLOCK_RESOURCES</em></span> in
  <span class="emphasis"><em>/etc/sap_suse_cluster_connector</em></span> is not allowed anymore.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-always-use-unique-instance-numbers"></a>Always use unique instance numbers</h4></div></div></div><p>Currently all SAP <span class="strong"><strong>instance numbers controlled by the cluster must be unique</strong></span>.
  If you need multiple dialog instances, such as D00, running on different
  systems, they should not be controlled by the cluster.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-setting-the-cluster-to-maintenance-mode"></a>Setting the cluster to maintenance mode</h4></div></div></div><p>The procedure to set the cluster into maintenance mode can be executed as user <span class="emphasis"><em>root</em></span> or <span class="emphasis"><em>sidadm</em></span>.</p><p>As user <span class="emphasis"><em>root</em></span>, type the following command:</p><pre class="screen"># crm configure property maintenance-mode="true"</pre><p>See also manual page crm(8).</p><p>As user <span class="emphasis"><em>en2adm</em></span>, type the following command (the full path is needed):</p><pre class="screen"># /usr/sbin/crm configure property maintenance-mode="true"</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-stopping-the-cluster-maintenance"></a>Stopping the cluster maintenance</h4></div></div></div><p>The procedure to end the maintenance mode for the cluster can be executed as user <span class="emphasis"><em>root</em></span>.
Type the following command:</p><pre class="screen"># crm configure property maintenance-mode="false"</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-starting-the-resource-maintenance-mode"></a>Starting the resource maintenance mode</h4></div></div></div><p>The procedure to start the resource maintenance mode can be executed as user <span class="emphasis"><em>en2adm</em></span>.
This sets the ASCS and ERS cluster resource to <span class="strong"><strong>unmanaged</strong></span>.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, type the command:</p><pre class="screen"># sapcontrol -nr 00 -function HASetMaintenanceMode 1</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-stopping-the-resource-maintenance-mode"></a>Stopping the Resource Maintenance Mode</h4></div></div></div><p>The procedure to start the resource maintenance mode can be executed as user <span class="emphasis"><em>en2adm</em></span>.
This sets the ASCS and ERS cluster resource to <span class="strong"><strong>managed</strong></span>.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, type the command:</p><pre class="screen"># sapcontrol -nr 00 -function HASetMaintenanceMode 0</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-cleaning-up-resources"></a>Cleaning up resources</h4></div></div></div><p>You can also <span class="strong"><strong>clean-up resource failures</strong></span>. Failures of the ASCS will be automatically
  deleted to allow a failback after the configured period of time. For all other
  resources, you can clean-up the status including the failures.</p><p>As user <span class="emphasis"><em>root</em></span>, type the following command:</p><pre class="screen"># crm resource cleanup RESOURCE-NAME</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="id-testing-the-cluster"></a>Testing the cluster</h3></div></div></div><p>It is strongly recommended to perform at least the following tests before you
go into production with your cluster:</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-checking-product-names-with-hagetfailoverconfig"></a>Checking Product Names with HAGetFailoverConfig</h4></div></div></div><p>Check if the name of the SUSE cluster solution is shown in the output of
  <span class="strong"><strong>sapcontrol</strong></span> or the SAP management console. This test checks the status of the
  SAP NetWeaver cluster integration.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, type the following command:</p><pre class="screen"># sapcontrol -nr 00 -function HAGetFailoverConfig</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-running-sap-checks-using-hacheckconfig-and-hacheckfailoverconfig"></a>Running SAP checks using HACheckConfig and HACheckFailoverConfig</h4></div></div></div><p>Check if the HA configuration tests are passed successfully and do not produce error messages.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, type the following commands:</p><pre class="screen"># sapcontrol -nr 00 -function HACheckConfig
# sapcontrol -nr 00 -function HACheckFailoverConfig</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-manually-migrating-ascs"></a>Manually migrating ASCS</h4></div></div></div><p>Check if manually migrating the ASCS instance using HA tools works properly.</p><p>As user <span class="emphasis"><em>root</em></span>, run the following commands:</p><pre class="screen"># crm resource migrate rsc_sap_EN2_ASCS00 force
## wait until the ASCS is been migrated to the ERS host
# crm resource unmigrate rsc_sap_EN2_ASCS00</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-migrating-ascs-using-hafailovertonode"></a>Migrating ASCS using HAFailoverToNode</h4></div></div></div><p>Check if moving the ASCS instance using SAP tools like sapcontrol works properly.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, type the following command:</p><pre class="screen"># sapcontrol -nr 00 -function HAFailoverToNode ""</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-testing-ascs-migration-after-operating-system-failure"></a>Testing ASCS migration after operating system failure</h4></div></div></div><p>Check if the ASCS instance moves correctly after a node failure.
This test will immediately trigger a hard reboot of the node.</p><p>As user <span class="emphasis"><em>root</em></span>, type the following command:</p><pre class="screen">## on the ASCS host
# echo b &gt;/proc/sysrq-trigger</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-restarting-ascs-in-place-using-stop-and-start"></a>Restarting ASCS in-place using <span class="emphasis"><em>Stop</em></span> and <span class="emphasis"><em>Start</em></span></h4></div></div></div><p>Check if the in-place restart of the SAP resources have been processed
  correctly. The SAP instance should not failover to an other node, it
  must start on the same node where it has been stopped.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, do the following:</p><pre class="screen">## example for ASCS
# sapcontrol -nr 00 -function Stop
## wait till the ASCS is completely down
# sapcontrol -nr 00 -function Start</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-automated-restart-of-the-ascs-instance-simulating-rolling-kernel-switch"></a>Automated restart of the ASCS instance (simulating rolling kernel switch)</h4></div></div></div><p>The next test should proof that the cluster solution did nor interact neither try to restart the ASCS instance
during a maintenance procedure. In addition, it should verify that no locks are lost during the restart of
an ASCS instance during an RKS procedure. The cluster solution should recognize that the restart of
the ASCS instance was expected. No failure or error should be reported or counted.</p><p>Optionally, you can set locks and verify that they still exist after the maintenance procedure. There are multiple
ways to do that. One example test can be performed as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log in to your SAP system and open the transaction SU01.</p></li><li class="listitem"><p>Create a new user. Do not finish the transaction to see the locks.</p></li><li class="listitem"><p>With the SAP MC / MMC, check if there are locks available.</p></li><li class="listitem"><p>Open the ASCS instance entry and go to <span class="emphasis"><em>Enqueue Locks</em></span>.</p></li><li class="listitem"><p>With the transaction SM12, you can also see the locks.</p></li></ol></div><p>Do this test multiple times in a short time frame. The restart of the ASCS instance in the example below happens five times.</p><p>As user <span class="emphasis"><em>en2adm</em></span>, create and execute the following script:</p><pre class="screen">$ cat ascs_restart.sh
#!/bin/bash
for lo in 1 2 3 4 5; do
  echo LOOP "$lo - Restart ASCS00"
  sapcontrol -host sapen2as -nr 00 -function StopWait 120 1
  sleep 1
  sapcontrol -host sapen2as -nr 00 -function StartWait 120 1
  sleep 1
done</pre><pre class="screen">$ bash ascs_restart.sh</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-rolling-kernel-switch-procedure"></a>Rolling kernel switch procedure</h4></div></div></div><p>The rolling kernel switch (RKS) is an automated procedure that enables the kernel in an ABAP system
to be exchanged without any system downtime. During an RKS, all instances of the system, and
generally all SAP start services (sapstartsrv), are restarted.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Check in SAP note 953653 whether the new kernel patch is RKS compatible to your currently running kernel.</p></li><li class="listitem"><p>Check SAP note 2077934 - Rolling kernel switch in HA environments.</p></li><li class="listitem"><p>Download the new kernel from the SAP service market place.</p></li><li class="listitem"><p>Make a backup of your current central kernel directory.</p></li><li class="listitem"><p>Extract the new kernel archive to the central kernel directory.</p></li><li class="listitem"><p>Start the RKS via SAP MMC, system overview (transaction SM51) or via command line.</p></li><li class="listitem"><p>Monitor and check the version of your SAP instances with the SAP MC / MMC or with <span class="strong"><strong>sapcontrol</strong></span>.</p></li></ol></div><p>As user <span class="emphasis"><em>en2adm</em></span>, type the following commands:</p><pre class="screen">## sapcontrol [-user &lt;sidadm psw&gt;] -host &lt;host&gt; -nr &lt;INSTANCE_NR&gt; -function UpdateSystem 120 300 1
# sapcontrol -user en2adm &lt;use-your-secure-pwd&gt; -host sapen2as -nr 00 -function UpdateSystem 120 300 1
# sapcontrol -nr 00 -function GetSystemUpdateList -host sapen2as \
  -user en2adm &lt;use-your-secure-pwd&gt;
# sapcontrol -nr 00 -function GetVersionInfo -host sapen2as \
  -user en2adm &lt;use-your-secure-pwd&gt;
# sapcontrol -nr 10 -function GetVersionInfo -host sapen2er \
  -user en2adm &lt;use-your-secure-pwd&gt;
# sapcontrol -nr 01 -function GetVersionInfo -host sapen2d1 \
  -user en2adm &lt;use-your-secure-pwd&gt;
# sapcontrol -nr 02 -function GetVersionInfo -host sapen2d2 \
  -user en2adm &lt;use-your-secure-pwd&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="id-additional-tests"></a>Additional tests</h4></div></div></div><p>In addition to the already performed tests, you should do the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Check the recoverable and non-recoverable outage of the message server process.</p></li><li class="listitem"><p>Check the non-recoverable outage of the SAP enqueue server process.</p></li><li class="listitem"><p>Check the outage of the SAP Enqueue Replication Server 2.</p></li><li class="listitem"><p>Check the outage and restart of sapstartsrv.</p></li><li class="listitem"><p>Check the simulation of an upgrade.</p></li><li class="listitem"><p>Check the simulation of cluster resource failures.</p></li></ul></div></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="id-implementing-the-cluster.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="multicluster.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Implementing the cluster </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Multi-node cluster setups for an SAP S/4HANA</td></tr></table></div></body></html>